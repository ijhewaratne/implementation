{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CHA Hydraulic Simulation Output",
  "description": "Complete contract for CHA physics-based results with thermal simulation, pump power, and standards compliance",
  "type": "object",
  "required": ["metadata", "nodes", "pipes", "kpis", "compliance", "crs", "units"],
  "properties": {
    "metadata": {
      "type": "object",
      "required": ["simulation_timestamp", "pandapipes_version", "convergence_status"],
      "properties": {
        "simulation_timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of simulation completion"
        },
        "pandapipes_version": {
          "type": "string",
          "description": "Version of pandapipes used for simulation"
        },
        "convergence_status": {
          "type": "string",
          "enum": ["converged", "max_iterations", "failed"],
          "description": "Convergence status of the simulation"
        },
        "total_iterations": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of iterations completed"
        },
        "simulation_duration_s": {
          "type": "number",
          "minimum": 0,
          "description": "Simulation duration in seconds"
        },
        "thermal_simulation_enabled": {
          "type": "boolean",
          "description": "Whether thermal simulation was enabled"
        },
        "auto_resize_enabled": {
          "type": "boolean",
          "description": "Whether auto-resize was enabled"
        },
        "network_size": {
          "type": "object",
          "properties": {
            "junctions": {"type": "integer", "minimum": 0},
            "pipes": {"type": "integer", "minimum": 0},
            "sources": {"type": "integer", "minimum": 0},
            "sinks": {"type": "integer", "minimum": 0}
          }
        }
      }
    },
    "nodes": {
      "type": "array",
      "description": "Network nodes (junctions, sources, sinks) with hydraulic and thermal results",
      "items": {
        "type": "object",
        "required": ["id", "x", "y", "p_bar", "t_c", "node_type"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique node identifier"
          },
          "x": {
            "type": "number",
            "description": "X coordinate in CRS units"
          },
          "y": {
            "type": "number",
            "description": "Y coordinate in CRS units"
          },
          "p_bar": {
            "type": "number",
            "minimum": 0,
            "description": "Pressure in bar"
          },
          "t_c": {
            "type": "number",
            "minimum": 0,
            "maximum": 100,
            "description": "Temperature in Celsius"
          },
          "node_type": {
            "type": "string",
            "enum": ["junction", "source", "sink"],
            "description": "Type of network node"
          },
          "mdot_kg_s": {
            "type": "number",
            "minimum": 0,
            "description": "Mass flow rate in kg/s (for sources/sinks)"
          },
          "elevation_m": {
            "type": "number",
            "description": "Elevation above sea level in meters"
          }
        }
      }
    },
    "pipes": {
      "type": "array",
      "description": "Network pipes with hydraulic and thermal results",
      "items": {
        "type": "object",
        "required": ["id", "dn_mm", "v_ms", "dp100m_pa", "mdot_kg_s", "t_seg_c", "pipe_category"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique pipe identifier"
          },
          "from_node": {
            "type": "string",
            "description": "Upstream node ID"
          },
          "to_node": {
            "type": "string",
            "description": "Downstream node ID"
          },
          "length_m": {
            "type": "number",
            "minimum": 0,
            "description": "Pipe length in meters"
          },
          "dn_mm": {
            "type": "number",
            "minimum": 25,
            "maximum": 400,
            "description": "Nominal diameter in millimeters"
          },
          "v_ms": {
            "type": "number",
            "minimum": 0,
            "maximum": 3.0,
            "description": "Flow velocity in m/s"
          },
          "dp100m_pa": {
            "type": "number",
            "minimum": 0,
            "maximum": 1000,
            "description": "Pressure drop per 100m in Pa"
          },
          "mdot_kg_s": {
            "type": "number",
            "minimum": 0,
            "description": "Mass flow rate in kg/s"
          },
          "t_seg_c": {
            "type": "number",
            "minimum": 0,
            "maximum": 100,
            "description": "Average segment temperature in Celsius"
          },
          "pipe_category": {
            "type": "string",
            "enum": ["mains", "distribution", "services"],
            "description": "Pipe category for standards compliance"
          },
          "q_loss_Wm": {
            "type": "number",
            "minimum": 0,
            "description": "Thermal loss per meter in W/m"
          },
          "reynolds_number": {
            "type": "number",
            "minimum": 0,
            "description": "Reynolds number for flow regime"
          },
          "friction_factor": {
            "type": "number",
            "minimum": 0,
            "description": "Darcy friction factor"
          },
          "heat_transfer_coeff": {
            "type": "number",
            "minimum": 0,
            "description": "Heat transfer coefficient in W/(m²·K)"
          }
        }
      }
    },
    "kpis": {
      "type": "object",
      "description": "Key Performance Indicators for the network",
      "required": ["v_max_ms", "dp100m_max_pa", "pump_kw", "losses_mwh_a", "dt_k", "thermal_efficiency"],
      "properties": {
        "v_max_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum velocity in the network (m/s)"
        },
        "dp100m_max_pa": {
          "type": "number",
          "minimum": 0,
          "description": "Maximum pressure drop per 100m (Pa)"
        },
        "pump_kw": {
          "type": "number",
          "minimum": 0,
          "description": "Total pump power required (kW)"
        },
        "losses_mwh_a": {
          "type": "number",
          "minimum": 0,
          "description": "Total thermal losses per year (MWh/a)"
        },
        "dt_k": {
          "type": "number",
          "minimum": 0,
          "description": "Network temperature drop (K)"
        },
        "thermal_efficiency": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Thermal efficiency of the network"
        },
        "total_flow_kg_s": {
          "type": "number",
          "minimum": 0,
          "description": "Total mass flow rate (kg/s)"
        },
        "network_length_km": {
          "type": "number",
          "minimum": 0,
          "description": "Total network length (km)"
        },
        "supply_temp_c": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Supply temperature (Celsius)"
        },
        "return_temp_c": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Return temperature (Celsius)"
        }
      }
    },
    "compliance": {
      "type": "object",
      "description": "Standards compliance and validation results",
      "required": ["overall_status", "standards_results", "violations"],
      "properties": {
        "overall_status": {
          "type": "string",
          "enum": ["PASS", "FAIL", "WARNING"],
          "description": "Overall compliance status"
        },
        "standards_results": {
          "type": "object",
          "description": "Results for each engineering standard",
          "properties": {
            "EN_13941": {
              "type": "string",
              "enum": ["PASS", "FAIL"],
              "description": "EN 13941 compliance status"
            },
            "DIN_1988": {
              "type": "string",
              "enum": ["PASS", "FAIL"],
              "description": "DIN 1988 compliance status"
            },
            "VDI_2067": {
              "type": "string",
              "enum": ["PASS", "FAIL"],
              "description": "VDI 2067 compliance status"
            }
          }
        },
        "violations": {
          "type": "array",
          "description": "List of standards violations",
          "items": {
            "type": "object",
            "required": ["type", "severity", "pipe_id", "value", "limit"],
            "properties": {
              "type": {
                "type": "string",
                "enum": ["velocity", "pressure_drop", "temperature_drop", "thermal_loss"],
                "description": "Type of violation"
              },
              "severity": {
                "type": "string",
                "enum": ["critical", "warning", "info"],
                "description": "Severity level of violation"
              },
              "pipe_id": {
                "type": "string",
                "description": "ID of pipe with violation"
              },
              "value": {
                "type": "number",
                "description": "Actual value that violates limit"
              },
              "limit": {
                "type": "number",
                "description": "Maximum allowed value"
              },
              "standard": {
                "type": "string",
                "description": "Standard that was violated"
              },
              "recommendation": {
                "type": "string",
                "description": "Recommended action to fix violation"
              }
            }
          }
        },
        "auto_resize_results": {
          "type": "object",
          "description": "Results from auto-resize process",
          "properties": {
            "iterations_completed": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of resize iterations completed"
            },
            "pipes_resized": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of pipes that were resized"
            },
            "final_compliance": {
              "type": "boolean",
              "description": "Whether final result is compliant"
            },
            "resize_history": {
              "type": "array",
              "description": "History of resize iterations",
              "items": {
                "type": "object",
                "properties": {
                  "iteration": {"type": "integer"},
                  "violations_found": {"type": "integer"},
                  "pipes_resized": {"type": "integer"}
                }
              }
            }
          }
        }
      }
    },
    "crs": {
      "type": "object",
      "description": "Coordinate Reference System information",
      "required": ["epsg", "name", "units"],
      "properties": {
        "epsg": {
          "type": "integer",
          "description": "EPSG code of the CRS"
        },
        "name": {
          "type": "string",
          "description": "Name of the CRS"
        },
        "units": {
          "type": "string",
          "description": "Units of the CRS (e.g., 'm', 'ft')"
        }
      }
    },
    "units": {
      "type": "object",
      "description": "Units for all physical quantities",
      "required": ["pressure", "temperature", "flow_rate", "power", "energy", "length"],
      "properties": {
        "pressure": {
          "type": "string",
          "enum": ["bar", "Pa", "kPa", "MPa"],
          "description": "Pressure units"
        },
        "temperature": {
          "type": "string",
          "enum": ["C", "K", "F"],
          "description": "Temperature units"
        },
        "flow_rate": {
          "type": "string",
          "enum": ["kg_s", "m3_s", "l_s"],
          "description": "Flow rate units"
        },
        "power": {
          "type": "string",
          "enum": ["W", "kW", "MW"],
          "description": "Power units"
        },
        "energy": {
          "type": "string",
          "enum": ["J", "kJ", "MJ", "Wh", "kWh", "MWh"],
          "description": "Energy units"
        },
        "length": {
          "type": "string",
          "enum": ["m", "mm", "km"],
          "description": "Length units"
        },
        "velocity": {
          "type": "string",
          "enum": ["m_s", "km_h"],
          "description": "Velocity units"
        },
        "diameter": {
          "type": "string",
          "enum": ["mm", "m", "in"],
          "description": "Diameter units"
        }
      }
    },
    "thermal_analysis": {
      "type": "object",
      "description": "Detailed thermal analysis results",
      "properties": {
        "pump_power_analysis": {
          "type": "object",
          "properties": {
            "total_pump_power_w": {"type": "number", "minimum": 0},
            "total_pump_power_kw": {"type": "number", "minimum": 0},
            "pump_efficiency": {"type": "number", "minimum": 0, "maximum": 1},
            "pipe_details": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "pipe_id": {"type": "string"},
                  "pressure_drop_pa": {"type": "number"},
                  "volumetric_flow_m3_s": {"type": "number"},
                  "pump_power_w": {"type": "number"}
                }
              }
            }
          }
        },
        "thermal_loss_analysis": {
          "type": "object",
          "properties": {
            "total_thermal_loss_w": {"type": "number", "minimum": 0},
            "total_thermal_loss_kw": {"type": "number", "minimum": 0},
            "pipe_details": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "pipe_id": {"type": "string"},
                  "surface_area_m2": {"type": "number"},
                  "heat_transfer_coeff": {"type": "number"},
                  "delta_t_k": {"type": "number"},
                  "thermal_loss_w": {"type": "number"}
                }
              }
            }
          }
        },
        "temperature_profiles": {
          "type": "object",
          "properties": {
            "network_temp_drop_c": {"type": "number"},
            "max_inlet_temp_c": {"type": "number"},
            "min_outlet_temp_c": {"type": "number"},
            "pipe_profiles": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "pipe_id": {"type": "string"},
                  "inlet_temp_c": {"type": "number"},
                  "outlet_temp_c": {"type": "number"},
                  "temp_drop_c": {"type": "number"},
                  "thermal_loss_w": {"type": "number"}
                }
              }
            }
          }
        }
      }
    }
  },
  "additionalProperties": false
}
